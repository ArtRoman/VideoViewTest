# VideoViewTest
Testing video playback issues on Android platform.

Android up to 4.4 has VideoView init limit (2k-8k, depending on device), then it gets MediaPlayer.onPrepared event timeout and strange memory issues: throwing TransactionTooLargeException in any time of using external services like PackageManager, stopping app when starting/closing activity and restarting app in another process (so device can keep up to 5 processes with your app at the same time), etc.

Copy-pasting the VideoView class without using MediaController and SubtitleController helps a lot, but on large numbers of init times it can be not stable, too.

Using ExoPlayer seems to be a good solution, but it also have hardware problems on some devices when using some SurfaceViews simultaneously (OMX.amlogic.avc.decoder.awesome ERROR 0x80001000).


# (RUS) Тест для VideoView
Android версии 4.4 и ниже имеет явную проблему лимита количества инициализаций стандартного элемента VideoView. В зависимости от устройства (производитель, видеопроцессор, медиакодек), обычно это 2000-8000 инициализаций видео в рамках одного процесса, вне зависимости от переключений Activity и пр.

Не важно, каким образом происходит инициализация – добавлением новых элементов VideoView вместо старых, или просто повторной установкой setVideoPath()/setVideoURI() и запуском видео, имеется факт наличия ограничения количества инициализаций.

В приложении реализовано три варианта реализации элемента для воспроизведения видео для тестирования на конечных устройствах

Для наиболее быстрого тестирования выбрана следующая методика:
- видеофайл из ресурсов приложения копируется на накопитель для прямого доступа к файлу
- инициализируется VideoView, устанавливаются подписчики на событие окончания инициализации
- по факту окончания инициализации видео запускается; при количестве инициализаций, кратным 100, видео воспроизводится секунду
- после этого видео останавливается, освобождаются ресурсы, и снова запускается процесс инициализации
- при каждой инициализации запускается 5-секундный таймер, отслеживающий таймаут процесса инициализации, который говорит о том, что видео больше не может быть инициализировано. 

При достижения лимита инициализаций, приложение ведёт себя крайне нестабильно, при любом обращении к сервисам Android через getSystemService системой будет выброшен TransactionTooLargeException, который обычно говорит о проблеме межпроцессного взаимодействия с помощью Binder'а. Запуск/остановка Activity может привести к перезапуску всего приложения в новом процессе, причём старый не будет полностью закрыт – фоновые потоки могут продолжать работать, приводя к порче данных и т.д. В отдельных случаях я получал до пяти одновременно работающих, одинаково называющихся, процессов приложения. При всём при этом, памяти у каждого процесса выделено достаточно, переполнений не происходит, OOM не вызывается. В новых процессах видео инициализируется нормально, до достижения лимита в очередной раз, который при постоянных инициализациях (2-5 в секунду) может произойти и через 10 минут работы приложения.

В таком состоянии можно дополнительно протестировать приложение на работоспособность в экстремальных условиях нехватки ресурсов (лимит Binder'ов?), на обработку редких ситуаций типа обработку некоторых видов редко встречающихся исключений.

# CustomVideoView
Создание пользовательского класса CustomVideoView, который содержит оригинальный код стандартного VideoView (за исключением элементов, использующих закрытое API - MediaController и SubtitleController), значительно улучшает ситуаицию, позволяя произвести в разы большее количество инициализаций видео, что неявно говорит о проблемах Android с памятью при использовании нативных методов, которые используются внутри MediaPlayer, MediaController и SubtitleController.

# ExoPlayer
Использование нового API для работы с аудио/видео, предоставлямое проектом ExoPlayer от Google позволяет избавиться от проблемы, так как в нём не используются системные библиотеки MediaPlayer, MediaController и SubtitleController, но на многих устройствах появляются другие сложности, например более долгий процесс инициализации видео, неработоспособность зацикливания перемоткой в начало по окончанию, и пр.

# Результаты
Проверив на нескольких устройствах, получил следующие результаты:
- ODROID C1+, Android 4.4, 2738…2742 инициализаций VideoView (TTL через 10 минут), 49277 для CustomVideoView (ANR после 17 часов)
- Texet TM-9767, 4.4, 8962 (VideoView), 8965 (CustomVideoView)
- Samsung Galaxy Tab S, 4.4, 8963 (VideoView)
- Nexus 7, 6.0, 8964 (ANR в CustomVideoView)
- Nexus 5, 6.0, 8971 (ANR в VideoView)
- Samsung Galaxy Tab 8, 4.4, 9000
